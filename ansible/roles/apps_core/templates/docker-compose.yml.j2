# --- CONFIGURAÇÃO GLOBAL DE LOGS (Evita disco cheio) ---
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  # ---------------------------------------------------------------------------
  # 1. CONECTIVIDADE & SEGURANÇA DE BORDA
  # ---------------------------------------------------------------------------
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: nic_tunnel
    restart: always
    command: tunnel --metrics 0.0.0.0:2000 run
    user: "65532:65532"
    read_only: true
    cap_drop: [ALL]
    security_opt: [no-new-privileges:true]
    environment:
      - TUNNEL_TOKEN={{ cloudflare_tunnel_token }}
      - TUNNEL_TRANSPORT_PROTOCOL=quic
      - TUNNEL_LOGLEVEL=info
    sysctls:
      - net.core.somaxconn=65535
    networks:
      - nic_net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:2000/ready"]
      interval: 30s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits: { memory: 256M }
    logging: *default-logging

  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: nic_waf
    restart: always
    environment:
      - GID=1000
      - COLLECTIONS=crowdsecurity/linux crowdsecurity/vaultwarden crowdsecurity/postgresql crowdsecurity/http-cve
      - ENROLL_KEY={{ crowdsec_enroll_key | default('') }}
      - ENROLL_TAGS=nic-labs
    volumes:
      - crowdsec_db:/var/lib/crowdsec/data
      - crowdsec_config:/etc/crowdsec
      - /var/log/auth.log:/var/log/auth.log:ro
      - /var/log/syslog:/var/log/syslog:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/crowdsec/acquis.yaml:/etc/crowdsec/acquis.yaml:ro
    networks:
      - nic_net
    security_opt: [no-new-privileges:true]
    logging: *default-logging

  crowdsec-bouncer:
    image: crowdsecurity/cloudflare-bouncer:latest
    container_name: nic_waf_bouncer
    restart: always
    depends_on: [crowdsec]
    environment:
      - CF_API_TOKEN={{ cloudflare_waf_token }}
      - CF_ZONE_ID={{ cloudflare_zone_id }}
      - CROWDSEC_LAPI_URL=http://crowdsec:8080
      - CROWDSEC_LAPI_KEY={{ crowdsec_bouncer_api_key }}
      - UPDATE_FREQUENCY=10s
    networks:
      - nic_net
    logging: *default-logging

  # ---------------------------------------------------------------------------
  # 2. PERFOMANCE & CACHE (REDIS)
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: nic_redis
    restart: always
    command: redis-server --save 60 1 --loglevel warning --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - nic_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
    logging: *default-logging

  # ---------------------------------------------------------------------------
  # 3. INFRAESTRUTURA & GESTÃO
  # ---------------------------------------------------------------------------
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    command: --admin-password-file /run/secrets/portainer_admin_pass
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
      - ./secrets/portainer_pass:/run/secrets/portainer_admin_pass:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - nic_net
    security_opt: [no-new-privileges:true]
    logging: *default-logging

  postgres:
    image: postgres:15.5-alpine
    container_name: nic_postgres
    restart: always
    command: >
      postgres
      -c shared_buffers=1GB
      -c effective_cache_size=3GB
      -c maintenance_work_mem=256MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=16MB
      -c max_connections=300
    environment:
      - POSTGRES_USER={{ db_user | default('nic_admin') }}
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_root_pass
      - POSTGRES_DB=nic_core_db
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
      - ./secrets/postgres_root_pass:/run/secrets/postgres_root_pass:ro
    networks:
      - nic_net
    security_opt: [no-new-privileges:true]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ db_user | default('nic_admin') }} -d nic_core_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits: { memory: 1G, cpus: '1.0' }
    logging: *default-logging

  # ---------------------------------------------------------------------------
  # 4. APLICAÇÕES CORE (Senhas, Arquivos, Chat)
  # ---------------------------------------------------------------------------
  nicvault:
    image: vaultwarden/server:1.30.5-alpine
    container_name: nicvault
    restart: always
    environment:
      - DOMAIN=https://vault.nic-labs.com
      - SIGNUPS_ALLOWED=false
      - INVITATIONS_ALLOWED=false
      - IP_HEADER=CF-Connecting-IP
      - ADMIN_TOKEN_FILE=/run/secrets/admin_token
      - WEBSOCKET_ENABLED=true
    volumes:
      - vw_data:/data
      - ./secrets/nicvault_admin_token:/run/secrets/admin_token:ro
    networks:
      - nic_net
    security_opt: [no-new-privileges:true]
    cap_drop: [ALL]
    cap_add: [SETGID, SETUID]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/alive"]
      interval: 60s
      timeout: 10s
    logging: *default-logging

  mattermost:
    image: mattermost/mattermost-team-edition:9.5.1
    container_name: mattermost
    restart: always
    user: "${MM_UID:-2000}:${MM_GID:-2000}"
    read_only: true
    tmpfs: [/tmp, /mattermost/logs]
    environment:
      - MM_SERVICESETTINGS_SITEURL=https://chat.nic-labs.com
      - MM_SERVICESETTINGS_LISTENADDRESS=:8065
      - MM_SQLSETTINGS_DRIVERNAME=postgres
      - MM_SQLSETTINGS_DATASOURCE=postgres://mmuser:{{ mattermost_db_password }}@nic_postgres:5432/mattermost?sslmode=disable&connect_timeout=10
      - MM_FILESETTINGS_DRIVERNAME={{ 'amazon_s3' if use_s3_storage else 'local' }}
      {% if use_s3_storage %}
      - MM_FILESETTINGS_AMAZONS3_BUCKET={{ r2_bucket }}
      - MM_FILESETTINGS_AMAZONS3_REGION=auto
      - MM_FILESETTINGS_AMAZONS3_ACCESSKEYID={{ r2_access_key }}
      - MM_FILESETTINGS_AMAZONS3_SECRETACCESSKEY={{ r2_secret_key }}
      - MM_FILESETTINGS_AMAZONS3_ENDPOINT={{ r2_endpoint }}
      - MM_FILESETTINGS_AMAZONS3_SSL=true
      - MM_FILESETTINGS_AMAZONS3_PATHPREFIX=mattermost-media
      {% endif %}
      - MM_PLUGINSETTINGS_ENABLEUPLOADS=true
      - MM_PLUGIN_CALLS_RTCD_UDP_PORT=8443 
      - MM_PLUGIN_CALLS_ICE_SERVERS=[{"urls":["stun:stun.l.google.com:19302"]}]
      - MM_REDISSETTINGS_ENABLE=true
      - MM_REDISSETTINGS_DATASOURCE=redis:6379
      - MM_SQLSETTINGS_MAXOPENCONNS=100
      - MM_SQLSETTINGS_MAXIDLECONNS=20
      - MM_SERVICESETTINGS_ENABLEGZIP=true
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - mm_config:/mattermost/config:rw
      - mm_data:/mattermost/data:rw
      - mm_plugins:/mattermost/plugins:rw
      - mm_client_plugins:/mattermost/client/plugins:rw
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
    networks:
      - nic_net
    deploy:
      resources:
        limits: { memory: 1.5G, cpus: '1.0' }
    logging: *default-logging

  ocis:
    image: owncloud/ocis:5.0.0
    container_name: nic_drive
    restart: always
    user: "1000:1000"
    read_only: true
    environment:
      - OCIS_URL=https://drive.nic-labs.com
      - OCIS_INSECURE=true
      - PROXY_HTTP_SRC_SUBNETS=0.0.0.0/0
      - OCIS_ADMIN_USER_ID=admin
      - OCIS_ADMIN_PASSWORD_FILE=/run/secrets/ocis_admin_password
      - STORAGE_USERS_DRIVER=ocis 
      - OCIS_BASE_DATA_PATH=/var/lib/ocis
    volumes:
      - ocis_data:/var/lib/ocis
      - ocis_config:/etc/ocis
      - ./secrets/ocis_pass:/run/secrets/ocis_admin_password:ro
      - /tmp/ocis-scratch:/tmp
    networks:
      - nic_net
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:9200/healthz"]
      interval: 10s
    deploy:
      resources:
        limits: { memory: 512M }
    logging: *default-logging

  # ---------------------------------------------------------------------------
  # 5. FERRAMENTAS AVANÇADAS (AI, Dados, Wi-Fi)
  # ---------------------------------------------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: nic_ollama
    restart: always
    tty: true
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_KEEP_ALIVE=24h
      - OLLAMA_NUM_PARALLEL=4
      - OLLAMA_MAX_LOADED_MODELS=1
      - OLLAMA_CTX_SIZE=8192
      - OLLAMA_ORIGINS="http://nic_chat:8080,http://localhost:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - nic_net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s

  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: nic_chat
    restart: always
    environment:
      - OLLAMA_BASE_URL=http://nic_ollama:11434
      - WEBUI_SECRET_KEY={{ openwebui_secret_key }}
      - ENABLE_SIGNUP=false
      - ENABLE_LOGIN_FORM=true
      - ENABLE_RAG_WEB_SEARCH=true 
      - RAG_EMBEDDING_ENGINE=ollama 
      - RAG_OLLAMA_BASE_URL=http://nic_ollama:11434
    volumes:
      - openwebui_data:/app/backend/data
    depends_on:
      ollama: { condition: service_healthy }
    networks:
      - nic_net
    logging: *default-logging

  nocodb:
    image: nocodb/nocodb:0.255.0
    container_name: nocodb
    restart: always
    environment:
      - NC_DB=pg://nic_postgres:5432?u=noco_user&p={{ nocodb_db_password }}&d=nocodb
      - NC_AUTH_JWT_SECRET={{ nocodb_jwt_secret }}
      - NC_PUBLIC_URL=https://noco.nic-labs.com
      - NODE_ENV=production
      - NC_DISABLE_TELEMETRY=true
    volumes:
      - nc_data:/usr/app/data
    depends_on:
      postgres: { condition: service_healthy }
    networks:
      - nic_net
    deploy:
      resources:
        limits: { memory: 1G }
    logging: *default-logging

  unifi:
    image: lscr.io/linuxserver/unifi-network-application:latest
    container_name: nic_unifi
    restart: always
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Sao_Paulo
      - MONGO_HOST=unifi-db
      - MONGO_PORT=27017
      - MONGO_DBNAME=unifi
      - MONGO_USER=unifi
      - MONGO_PASS={{ unifi_db_password }}
      - MONGO_AUTHSOURCE=unifi
      - MEM_LIMIT=2048
      - MEM_STARTUP=1536
      - MEM_MAX=1536
    depends_on:
      unifi-db: { condition: service_healthy }
    volumes:
      - unifi_config:/config
    ports:
      - "8080:8080"
      - "3478:3478/udp"
      - "10001:10001/udp"
    networks:
      - nic_net
    deploy:
      resources:
        limits: { memory: 1.5G }
    logging: *default-logging

  unifi-db:
    image: mongo:4.4
    container_name: unifi-db
    restart: always
    command: mongod --auth --bind_ip_all
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD={{ unifi_db_root_password }}
      - MONGO_PASS={{ unifi_db_password }} 
    volumes:
      - unifi_db_data:/data/db
      - ./scripts/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    networks:
      - nic_net
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongo localhost:27017/test --quiet
      interval: 10s
    logging: *default-logging

# ---------------------------------------------------------------------------
# VOLUMES E REDES
# ---------------------------------------------------------------------------
volumes:
  # Portainer
  portainer_data:

  # Vaultwarden
  vw_data:

  # Postgres & Dados
  pg_data:
  nc_data:

  # Mattermost
  mm_config:
  mm_data:
  mm_plugins:
  mm_client_plugins:

  # OCIS (OwnCloud)
  ocis_config:
  ocis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/nic-labs/core/ocis_data

  # UniFi
  unifi_config:
  unifi_db_data:

  # AI
  ollama_data:
  openwebui_data:

  # Segurança (CrowdSec)
  crowdsec_db:
  crowdsec_config:

  # Redis
  redis_data:

networks:
  nic_net:
    driver: bridge
