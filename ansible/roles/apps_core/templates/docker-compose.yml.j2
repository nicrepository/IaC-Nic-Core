  # --- ARQUIVOS (OwnCloud Infinite Scale - OCIS) ---
  ocis:
    image: owncloud/ocis:latest
    container_name: ocis
    restart: unless-stopped
    environment:
      - OCIS_INSECURE=true
      - OCIS_STORAGE_DRIVER=ocis
    volumes:
      - ocis_data:/var/lib/ocis
    networks:
      - nic_net
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 512M
    # Limite de espaço do volume para teste

version: '3.8'

# --- CONFIGURAÇÃO DE LOGS (Evita disco cheio) ---
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  # --- CONECTIVIDADE ZERO TRUST ---
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: nic_tunnel
    restart: unless-stopped
    command: command: tunnel --metrics 0.0.0.0:2000 run
    environment:
      - TUNNEL_TOKEN={{ cloudflare_tunnel_token }}
      - TUNNEL_TRANSPORT_PROTOCOL=quic
    networks:
      - nic_net
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 256M

  # --- GESTÃO DE CONTAINERS ---
  portainer:
    image: portainer/portainer-ce:2.19.4
    container_name: portainer
    restart: unless-stopped
    ports:
      - "9443:9443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - nic_net
    logging: *default-logging

  # --- PROXY REVERSO & SSL ---
  nginx_proxy:
    image: 'jc21/nginx-proxy-manager:2.11.0'
    container_name: nginx_proxy
    restart: unless-stopped
    ports:
      - '80:80'
      - '81:81'
      - '443:443'
    environment:
      - DISABLE_IPV6=true
      - X_FRAME_OPTIONS="SAMEORIGIN"
    volumes:
      - ./npm_data:/data
      - ./npm_letsencrypt:/etc/letsencrypt
      - ./npm_logs:/data/logs
    networks:
      - nic_net
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 512M

  # --- WAF COMPORTAMENTAL (CrowdSec) ---
  crowdsec:
    image: crowdsecurity/crowdsec:v1.6.0
    container_name: nic_waf
    restart: unless-stopped
    environment:
      - COLLECTIONS=crowdsecurity/nginx-proxy-manager crowdsecurity/http-cve crowdsecurity/whitelist-good-actors crowdsecurity/vaultwarden
      - GID=1000
    volumes:
      - crowdsec_db:/var/lib/crowdsec/data
      - crowdsec_config:/etc/crowdsec
      - ./npm_logs:/var/log/npm:ro
    networks:
      - nic_net
    logging: *default-logging
    security_opt:
      - no-new-privileges:true

  # --- GERENCIADOR DE SENHAS ---
  nicvault:
    image: vaultwarden/server:1.30.5-alpine
    container_name: nicvault
    restart: unless-stopped
    environment:
      - DOMAIN=https://vault.nic-labs.com
      - SIGNUPS_ALLOWED=false
      - INVITATIONS_ALLOWED=false
      - ADMIN_TOKEN={{ vault_password }}
      - WEBSOCKET_ENABLED=true
      - ROCKET_WORKERS=10
    volumes:
      - ./vw_data:/data
    networks:
      - nic_net
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 512M

  # --- BANCO DE DADOS ---
  postgres:
    image: postgres:15.5-alpine
    container_name: nic_postgres
    restart: unless-stopped
    command: postgres -c shared_buffers=256MB -c effective_cache_size=768MB -c maintenance_work_mem=64MB -c checkpoint_completion_target=0.9 -c wal_buffers=16MB -c default_statistics_target=100 -c random_page_cost=1.1 -c effective_io_concurrency=200 -c wal_level=replica -c max_wal_senders=10 -c hot_standby=on
    environment:
      POSTGRES_USER: {{ db_user | default('nic_admin') }}
      POSTGRES_PASSWORD: {{ db_password | default('MudeSuaSenha123') }}
      POSTGRES_DB: nic_core_db
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - nic_net
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 1G

  # --- PLATAFORMA DE DADOS ---
  nocodb:
    image: nocodb/nocodb:0.204.3
    container_name: nocodb
    restart: unless-stopped
    environment:
      NC_DB: "pg://nic_postgres:5432?u={{ db_user | default('nic_admin') }}&p={{ db_password | default('MudeSuaSenha123') }}&d=nic_core_db"
    depends_on:
      - postgres
    volumes:
      - nc_data:/usr/app/data
    networks:
      - nic_net
    logging: *default-logging

  # --- INTELIGENCIA ARTIFICIAL (Ollama + GPU) ---
  ollama:
    image: ollama/ollama:latest
    container_name: nic_ollama
    restart: unless-stopped
    tty: true
    environment:
      - OLLAMA_KEEP_ALIVE=24h        # Mantém o modelo na VRAM (resposta instantânea)
      - OLLAMA_NUM_PARALLEL=4        # Processa 4 usuários EXATAMENTE ao mesmo tempo
      - OLLAMA_MAX_LOADED_MODELS=1   # Foca a VRAM em 1 modelo para evitar swap
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - nic_net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # --- INTERFACE DE CHAT ---
  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: nic_chat
    restart: unless-stopped
    environment:
      - OLLAMA_BASE_URL=http://nic_ollama:11434
    volumes:
      - openwebui_data:/app/backend/data
    ports:
      - "3000:8080"
    depends_on:
      - ollama
    networks:
      - nic_net
    logging: *default-logging

  # --- CHAT (Mattermost Team Edition) ---
  mattermost:
    image: mattermost/mattermost-team-edition:latest
    container_name: mattermost
    restart: no
    environment:
      - MM_FILESETTINGS_DRIVERNAME=amazon_s3
      - MM_FILESETTINGS_AMAZONS3_ENDPOINT={{ r2_endpoint }}
      - MM_FILESETTINGS_AMAZONS3_ACCESSKEYID={{ r2_access_key }}
      - MM_FILESETTINGS_AMAZONS3_SECRETACCESSKEY={{ r2_secret_key }}
      - MM_FILESETTINGS_AMAZONS3_BUCKET={{ r2_bucket }}
      - MM_FILESETTINGS_AMAZONS3_REGION={{ r2_region | default('auto') }}
      - MM_FILESETTINGS_AMAZONS3_SSL=true
      - MM_FILESETTINGS_AMAZONS3_SIGNV2=false
      - MM_FILESETTINGS_AMAZONS3_S3DISABLESSL=false
      - MM_FILESETTINGS_AMAZONS3_FORCEPATHSTYLE=true
      - MM_FILESETTINGS_AMAZONS3_ENDPOINT={{ r2_endpoint }}
      - MM_FILESETTINGS_AMAZONS3_PATHPREFIX=/
      - MM_SQLSETTINGS_DRIVERNAME=postgres
      - MM_SQLSETTINGS_DATASOURCE=postgres://{{ db_user | default('nic_admin') }}:{{ db_password | default('MudeSuaSenha123') }}@nic_postgres:5432/mattermost?sslmode=disable&connect_timeout=10
    depends_on:
      - postgres
    networks:
      - nic_net
    logging: *default-logging
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 1G
    profiles: ["failover"]

volumes:
  portainer_data:
  npm_data:
  npm_letsencrypt:
  npm_logs: # Novo volume para Logs do Nginx
  vw_data:
  pg_data:
  nc_data:
  ollama_data:
  openwebui_data:
  crowdsec_db:
  crowdsec_config:

  ocis_data:
    driver: local
    driver_opts:
      type: none
      device: ./ocis_data
      o: bind
    # Limite de espaço para teste (10GB)
    # Para Docker Compose v2.18+ e Docker 23.0+: uncomment abaixo se suportado
    # driver_opts:
    #   size: 10g

networks:
  nic_net:
    driver: bridge