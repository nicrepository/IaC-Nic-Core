---
- name: Baixar script de instalação Wazuh (All-in-One)
  get_url:
    url: https://packages.wazuh.com/4.9/wazuh-install.sh
    dest: /tmp/wazuh-install.sh
    mode: '0744'

- name: Executar instalação do Wazuh
  shell: bash /tmp/wazuh-install.sh -a
  args:
    chdir: /tmp
    creates: /var/ossec/bin/wazuh-control
  register: wazuh_install_output

- name: Salvar as senhas geradas
  fetch:
    src: /tmp/wazuh-install-files.tar
    dest: ./wazuh-passwords
    flat: yes
  when: wazuh_install_output.changed

- name: Configurar Heap Size do Indexer para 16GB (50% da RAM)
  lineinfile:
    path: /etc/wazuh-indexer/jvm.options
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^-Xms', line: '-Xms16g' }
    - { regexp: '^-Xmx', line: '-Xmx16g' }
  notify: Reiniciar Indexer

- name: Impedir Swap de Memória (Performance Crítica)
  lineinfile:
    path: /etc/wazuh-indexer/opensearch.yml
    line: 'bootstrap.memory_lock: true'
  notify: Reiniciar Indexer

- name: Criar diretório de override do Systemd para o Indexer
  file:
    path: /etc/systemd/system/wazuh-indexer.service.d
    state: directory
    mode: '0755'

- name: Permitir Memlock ilimitado (Override seguro)
  copy:
    dest: /etc/systemd/system/wazuh-indexer.service.d/wazuh-indexer.conf
    content: |
      [Service]
      LimitMEMLOCK=infinity
  notify: Reiniciar Indexer

- name: Desabilitar repositórios do Wazuh (Evitar update acidental)
  replace:
    path: /etc/apt/sources.list.d/wazuh.list
    regexp: '^deb'
    replace: '#deb'

- name: Configurar Senha de Registro de Agentes (authd.pass)
  copy:
    content: "{{ wazuh_registration_password }}"
    dest: /var/ossec/etc/authd.pass
    owner: root
    group: wazuh
    mode: '0640'
  notify: Reiniciar Manager

- name: Criar Cron Job para limpar logs antigos do Wazuh (Archives)
  cron:
    name: "Limpar Wazuh Archives mais antigos que 7 dias"
    minute: "0"
    hour: "0"
    job: "find /var/ossec/logs/archives/ -type f -mtime +7 -delete"
    user: root

- name: Configurar Wazuh Manager (ossec.conf)
  template:
    src: ossec.conf.j2
    dest: /var/ossec/etc/ossec.conf
    owner: root
    group: wazuh
    mode: '0640'
  notify: Reiniciar Manager